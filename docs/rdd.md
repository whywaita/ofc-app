# Open Face Chinese Poker (OFCP) Flutter モバイルアプリ 要件定義 v0.2

> 対象読者: コーディングエージェント/実装担当、QA、PM。
> 目的: Flutter で iOS/Android 同時リリース可能な最小実装(MVP)から拡張までを、仕様と受け入れ基準レベルで明文化する。

---

## 0. エグゼクティブサマリ

* **アプリ名(仮):** Pineapple Lab
* **対象OS:** iOS/Android の最新メジャー2バージョンのみサポート
* **ランタイム:** Flutter 3.22+、Dart 3+、Null-safety 必須
* **ゲーム:** Open Face Chinese Poker (OFCP) 基本ルール + Pineapple 拡張をデフォルト有効
* **モード:**

  * ソロ練習(Bot対戦、オフライン可)
  * フレンド対戦(リアルタイム) \[将来追加]
  * ランダムマッチ(リアルタイム) \[将来追加]
* **サーバ:** 初期実装では不要。今後リアルタイム対戦実装時に要件化。
* **マネタイズ:** MVPでは無し。v1.1で広告/コイン制/サブスクを検討。
* **期限(仮):** v1.0 ベータ 8週間、v1.1 追加4週間。

---

## 1. ゴール/ノンゴール

### ゴール

* OFCP をルール誤解なく遊べる。手札配布、役判定、フォウル判定、スコア計算が完全自動。
* 途切れに強いリアルタイム対戦(将来実装)。
* UX: 1タップでカード移動、ドラッグ対応、配置アシスト(候補ハイライト)。

### ノンゴール(当面)

* 課金、ソーシャルグラフ連携、観戦モード、トーナメント、PvP レーティング。

---

## 2. 用語

* **Front/Middle/Back(Top/Middle/Bottom):** 上中下の3列(上=3枚、残り2列=5枚)。
* **Foul(フォウル):** 役強度が上>中>下の順序違反。
* **Fantasy Land:** 特定条件達成で次ハンド最初に追加枚数が配られるボーナス。
* **Pineapple:** 3枚配って2枚選ぶ等の派生ルール。本アプリではデフォルト有効。

---

## 3. ルール仕様

### 3.1 配札/進行

* 初期: 5枚配布。以降1〜3枚単位で配布。Pineapple 有効時は「3枚受け取り2枚選んで配置、1枚捨て」。捨て札は**非公開**で、ハンド終了時にリザルト画面から参照可能。
* 時間制: **MVPでは無効**。

### 3.2 役判定

* 下段・中段は5枚役、上段は3枚役(ペア/ハイカード/スリーカードのみ)。
* 標準役強度:

  * 5枚: Royal > Straight Flush > Four > Full House > Flush > Straight > Three > Two Pair > One Pair > High
  * 3枚: Three > Pair > High

### 3.3 フォウル判定

* 下段の役強度 ≥ 中段 ≥ 上段 を満たさない場合フォウル。
* 配置中は**リアルタイム**で検知し、確定不可として警告表示。

### 3.4 スコアリング(クラシック、ベース)

* **各列勝敗ポイント:** 列ごとに勝ち+1、負け-1、引き分け0。
* **スイープ(3列全勝):** 追加+3。
* **フォウル:** 自分-6、相手+6、ロイヤリティは無効。

### 3.5 ロイヤリティ(例/ベースライン)

* **上段(3枚):**

  * 66〜TT: +1、JJ: +2、QQ: +3、KK: +4、AA: +5、
  * 222: +7、333: +8、...、AAA: +22
* **中段(5枚):**

  * Three: +2、Straight: +4、Flush: +8、Full House: +12、Four: +20、Straight Flush: +30
* **下段(5枚):**

  * Straight: +2、Flush: +4、Full House: +6、Four: +10、Straight Flush: +15

### 3.6 Fantasy Land(更新仕様)

* **突入条件:** 上段でQQ以上、または上段Three cards、または下段Four cards以上を作成しフォウル無し。
* **配布枚数:**

  * QQ: 14枚
  * KK: 15枚
  * AA: 16枚
  * 上段Three cards: 17枚
* 継続条件: **上段 Three cards** または **下段 Four cards 以上** を達成すると継続。
* 操作: Fantasy 中は**全て手動配置**。**自動ソート**のみ提供（オート配置は行わない）。

---

## 4. UX/画面フロー

(変更なし)

---

## 5. 機能要件(抜粋)

* F-1: 役判定/フォウル/スコア計算を完全自動化、テストで網羅。
* F-2: オフライン Bot 対戦。難易度2段階。
* F-3: (将来) サーバ権威でシャッフルと進行管理。**MVPでは未実装**。
* F-4: 切断復帰(将来対応)。
* F-7: チュートリアルとプラクティス課題(フォウル回避練習)。
* F-8: 対戦形式は常に**2人制**。

---

## 6. 非機能要件

* カードスキンは1種類。
* 対応端末は iOS/Android の最新メジャー2バージョンのみ。

---

## 7. アーキテクチャ

* クライアント: Flutter。状態管理は Riverpod or Bloc。freezed/json\_serializable。
* サーバ: **初期実装では無し**。将来リアルタイム対戦追加時に Firebase/Supabase を検討。

---

## 8. データモデル(概略)

* MVPではローカルBot対戦のみのため、DB保存は不要。履歴は端末内保存。
* 将来拡張時には既存モデルを適用。

---

## 9. API

* 初期実装では不要。将来拡張で再導入。

---

## 10. マッチメイキング/リアルタイム

* **初期実装では対象外**。将来拡張時にサーバ権威モデルを実装。

---

## 11. Bot(簡易)

(変更なし)

---

## 12. セキュリティ/公正性

* 初期実装はオフラインのため不要。将来拡張でサーバシャッフル導入。

---

## 13. ローカライズ/法務

(変更なし)

---

## 14. 分析/計測

* 初期実装: 最小限 (クラッシュログ収集のみ)。

---

## 15. QA/受け入れ基準

* 付記: テストデータは適宜自動生成し、主要ケースのみゴールデン固定。
* AC-1: フォウルになる配置を行うと即時警告が出て確定不可。
* AC-2: Fantasy Land 条件を満たした場合、配布枚数が正しく増える。
* AC-3: スコアリングとロイヤリティが計算表と一致する。
* AC-4: 捨て札は対局中は非公開で、リザルト画面で正しく参照できる。

---

## 16. リリース計画(草案)

* W1-2: 役判定/スコアリング実装 + 単体テスト。
* W3: 盤面UI/ドラッグ&ドロップ。
* W4: オフラインBot対戦。
* W5: チュートリアル/多言語。
* W6: ベータ、クラッシュ修正。

---

## 18. 未決事項(更新)

1. デザイン基調: ダーク/ライト、配色参考アプリ。
2. マネタイズ: v1.1 以降の方針(広告/コイン/サブスク)。
3. 分析/SDK: Analytics等の追加要望。
4. 法務/年齢区分: プライバシーポリシー/利用規約準備状況。

---

